---
title: "Repeat A673 tumor only scRNAseq with HSV reference"
author: "Emily Franz"
date: "`r format(Sys.time(), '%m/%d/%Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 5
    number_sections: false
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  tidy = TRUE,
  echo = TRUE,
  cache = TRUE,
  collapse = TRUE,
  tidy.opts = list(width.cutoff = 95),
  message = FALSE,
  warning = FALSE,
  cache.lazy = FALSE)
```

```{r lib, cache = FALSE}
library(Seurat)
library(tidyverse)
library(ggsci) # find where needed
library(rrrSingleCellUtils)
library(patchwork)
source("scSeurat-addhsv.R")
# Set the random generator seed so that results are reproducible.
set.seed(888)

# Create files for saving if do not exist
if(!file.exists("Data")){
  dir.create("Data")
}
if(!file.exists("Plots")){
  dir.create("Plots")
}
if(!file.exists("Plots/A673_comb")){
  dir.create("Plots/A673_comb")
}

#my_dirs <- c(vector of dirnames)

#lapply(my_dirs[file.exists(my_dirs) == FALSE], #function(x) dir.create(x))
```

# Combine A673 Tumor Samples

## Normalize and Process

```{r process, fig.height=3, fig.width=3}
# Load the two A673 datasets
load("Data/tumor-only-A673_hsv_even-labeled.RData")
tumor_only <- A673_hsv_even
rm(A673_hsv_even)
load("Data/tumor-immune-A673_hsv_even-labeled.RData")
tumor_all <- A673_hsv_even
rm(A673_hsv_even)

A673_hsv_comb <- merge(tumor_only,
                       tumor_all,
                   add.cell.ids = c("A673_tumoronly",
                                    "A673_tumorall"),
                   project = "Trabectedin plus HSV1716 in A673 Combined Datasets") %>%
  process_seurat(resolution = 0.1,
                 run_umap_dims = 1:18)

ElbowPlot(A673_hsv_comb,
          ndims = 30)
```

### Clustering Resolution {.tabset}

#### Res0.1
```{r umap, fig.height=5, fig.width=10}
DimPlot(A673_hsv_comb,
        reduction = "umap",
        split.by = "treatment",
        pt.size = 1,
        label = T) +
  coord_fixed()
```

#### Res0.2
```{r, umap2, fig.height=5, fig.width=10}
A673_hsv_comb <- FindClusters(A673_hsv_comb,
                           resolution = 0.2)

DimPlot(A673_hsv_comb,
        reduction = "umap",
        split.by = "treatment",
        pt.size = 1,
        label = T) +
  coord_fixed()
```

#### Res0.3
```{r, umap3, fig.height=5, fig.width=10}
A673_hsv_comb <- FindClusters(A673_hsv_comb,
                           resolution = 0.3)

DimPlot(A673_hsv_comb,
        reduction = "umap",
        split.by = "treatment",
        pt.size = 1,
        label = T) +
  coord_fixed()
```

### DGEA by Cluster

Differentially Expressed Genes by Cluster (res0.3):
```{r deg}
A673_hsv_comb_markers <- FindAllMarkers(A673_hsv_comb,
                                     min.pct = 0.25,
                                     logfc.threshold = 0.25,
                                     only.pos = T)
```

```{r degt, dependson="deg"}

# Hard to work with this function/datatable so this step removes genes not in the top 10 DEG for all clusters 
# Print top 10 in each cluster
A673_hsv_comb_markers %>%
  group_by(cluster) %>%
  top_n(n = 10, wt = avg_log2FC) -> t

# Get dataframe into proper format  #need to pipe directly from 129 to 143
t <- as.data.frame(t)
t$cluster <- as.numeric(as.character(t$cluster)) # mutate
t <- t[order(t$cluster),] #arrange
t <- t[,c(7, 1:6)] # relocate
t <- t[,c(7, 1:6)] # relocate
#could also use arrange() to sort by column
# try using filter and select

# Create interactive datatable showing top 10 DEG in each cluster 
DT::datatable(t, 
              rownames = FALSE,
              extensions = c('FixedColumns',
                             'Buttons'),
              options = list(
                pageLength = 10,
                scrollX = TRUE,
                scrollCollapse = TRUE,
                dom = 'Bfrtip',
                buttons = c('copy',
                            'csv',
                            'excel')
              ))
```

Downsample so there is the same number of cells in each treatment group.

```{r downsample, fig.height=5, fig.width=10}
# Subset the highest number that makes all treatment groups equal in cell number
# subset # of cells from each ident of the seurat object 
Idents(A673_hsv_comb) <- A673_hsv_comb$treatment
A673_hsv_comb_even <- subset(A673_hsv_comb,
                          downsample = table(A673_hsv_comb$treatment) %>%
                            min())

# # the resulting object has one "row" per cell
table(A673_hsv_comb$treatment) %>%
  as.data.frame() # rename col

DimPlot(A673_hsv_comb_even,
        split.by = "treatment") +
  coord_fixed()

```

# oHSV Analysis

```{r matthelp_hsvgenes, dependson = c("umap","downsample")}
# Find head/prefix ^HSV1 in all genes (rownames) of tumor object
# Output is a vector of genes beginning with HSV1 that were found in the data:

hsv <- str_subset(row.names(A673_hsv_comb_even),
                  pattern = "^HSV1")
```

**All oHSV Genes Present:**

```{r hsv_genes, dependson = c("umap","downsample","matthelp_hsvgenes")}
# Create interactive datatable showing hsv genes
hsv_dt <- as.data.table(hsv)
DT::datatable(hsv_dt, 
              rownames = FALSE,
              extensions = c('FixedColumns',
                             'Buttons'),
              options = list(
                pageLength = 10,
                scrollX = TRUE,
                scrollCollapse = TRUE,
                dom = 'Bfrtip',
                buttons = c('copy',
                            'csv',
                            'excel')
              ))

```

A closer look at HSV transcript presence in the data.

```{r matthelp_assaydata, dependson = c("umap","downsample","matthelp_hsvgenes")}
#Make a compressed matrix of HSV1 genes as rownames and the corresponding single cell data for each gene (getassaydata is scaled data)
assay.data <- GetAssayData(A673_hsv_comb_even[hsv])

# Rownames of compressed matrix (assay.data) should be the genes from the subset of genes above (hsv <- str_subset)
#row.names(assay.data)

# Make a numeric vector of the column sums 
assay_col <- colSums(assay.data)

assay_col_unscaled <- GetAssayData(A673_hsv_comb_even[hsv], ) %>%
  colSums()
(assay_col > 0) %>%
  summary()
```

Distribution of HSV1 transcripts:

```{r tibble_hist, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata")}

#Use tibble and ggplot to look at histogram distribution of HSV genes 
tibble(cell_sum = assay_col) %>%
  ggplot(aes(cell_sum)) +
  geom_histogram(bins = 200)
```

Log normalized distribution of HSV1 transcripts: 
```{r tibble_hist_log, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata")}

#log scale helps to separate out low expression values and zero. We add 0.000001 to make sure we don't have log(0) (equals infinity so algorithm will remove these values) but can still view all the data points. 
tibble(cell_sum = assay_col) %>%
  ggplot(aes(cell_sum + 0.000001)) +
  geom_histogram(bins = 200) +
  scale_x_log10()
```

Given that this new analysis better captures viral presence, it is added to the tumor data as metadata. The UMAP distribution of oHSV transcripts is shown. 
```{r new_hsv_meta, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata")}
A673_hsv_comb_even <- AddMetaData(A673_hsv_comb_even,
                               assay_col,
                               col.name = "oHSV_abundance")

A673_hsv_comb_even <- AddMetaData(A673_hsv_comb_even,
                          assay_col > 0,
                          col.name = "oHSV_presence")
```

### DimPlots: oHSV presence

```{r hsvdimplot, fig.height=5, fig.width=10, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata","new_hsv_meta")}

Idents(A673_hsv_comb_even) <- A673_hsv_comb_even$oHSV_presence

# Change identities from TRUE/FALSE to infected/uninfected 
A673_hsv_comb_even <- RenameIdents(A673_hsv_comb_even, 
                                c("TRUE" = "oHSV+", 
                                  "FALSE" = "oHSV-"))

DimPlot(A673_hsv_comb_even,
        pt.size = 0.5,
        order = T) +
  ggtitle("oHSV Transcript Presence") +
  coord_fixed()

ohsvpresence <- DimPlot(A673_hsv_comb_even,
                        pt.size = 0.5,
                        split.by = "treatment",
                        order = TRUE) +
  ggtitle("oHSV Transcript Presence") +
  coord_fixed()
ohsvpresence

pdf("Plots/A673_comb/ohsv_presence_dimplot.pdf",
    height = 5, width = 10)
ohsvpresence
dev.off()
```

### FeaturePlots: oHSV abundance 

```{r featurehsv, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata","new_hsv_meta")}
FeaturePlot(A673_hsv_comb_even,
            features = "oHSV_abundance",
            order = TRUE) +
  theme(aspect.ratio = 1)
```

**Split by treatment group**
```{r feature_trt_hsv, fig.height = 3, fig.width = 12, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata","new_hsv_meta")}
FeaturePlot(A673_hsv_comb_even,
            split.by="treatment",
            features = "oHSV_abundance",
            order = TRUE) +
  theme(aspect.ratio = 1)
```


**Max Cutoff at 100**

```{r feature_trt_hsv_100, fig.height = 3, fig.width = 12, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata","new_hsv_meta")}
# Max cutoff at 100
FeaturePlot(A673_hsv_comb_even,
            split.by="treatment",
            features = "oHSV_abundance",
            order = TRUE,
            max.cutoff = 100) +
  theme(aspect.ratio = 1)
```


**Max Cutoff at 50**

```{r feature_trt_hsv_50, fig.height = 3, fig.width = 12, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata","new_hsv_meta")}
# Max cutoff at 50
FeaturePlot(A673_hsv_comb_even,
            split.by="treatment",
            features = "oHSV_abundance",
            order = TRUE,
            max.cutoff = 50) +
  theme(aspect.ratio = 1)
```


**Max Cutoff at 20**

```{r feature_trt_hsv_20, fig.height = 3, fig.width = 12, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata","new_hsv_meta")}
# Max cutoff at 50
FeaturePlot(A673_hsv_comb_even,
            split.by="treatment",
            features = "oHSV_abundance",
            order = TRUE,
            max.cutoff = 20) +
  theme(aspect.ratio = 1)
```

### Violin Plots: oHSV abundance

oHSV abundance is shown below across treatment groups, as well as by cluster and treatment groups. 

```{r hsv_ab, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata","new_hsv_meta")}
Idents(A673_hsv_comb_even) <- A673_hsv_comb_even$treatment

# Violin plots of HSV abundance
VlnPlot(A673_hsv_comb_even,
        features = "oHSV_abundance",
        split.by = "treatment")

obj4vln <- RenameIdents(A673_hsv_comb_even,
                        c("1 - Control" = "1",
                          "2 - oHSV" = "2",
                          "3 - Trabectedin" = "3",
                          "4 - oHSV+Trabectedin" = "4"))
log_ab <- VlnPlot(obj4vln,
                  features = "oHSV_abundance",
                  split.by = "treatment",
                  log = TRUE) +
  NoLegend()

log_ab
# save as pdf
pdf("Plots/A673_comb/vln_log_hsvabundance.pdf",
    height = 5, width = 5)
print(log_ab)
dev.off()

pdf("Plots/A673_comb/vln_log_hsvabundance2.pdf",
    height = 2, width = 8)
print(log_ab)
dev.off()

VlnPlot(A673_hsv_comb_even,
        features = "oHSV_abundance",
        split.by = "treatment",
        group.by = "seurat_clusters")

# Histogram of HSV abundance per treatment group
for (trtmnt in levels(A673_hsv_comb_even)) {
  ab_hist <- subset(A673_hsv_comb_even, idents = trtmnt) %>%
    feature_hist(features = "oHSV_abundance",
                 cutoff_table = NULL) +
    ggtitle("oHSV Abundance",
            subtitle = paste(trtmnt))
  # Print in Rmd
  print(ab_hist)
  # Save as pdf
  pdf(paste0("Plots/A673_comb/abundancehist_", trtmnt, ".pdf"),
      height = 5, width = 5)
  print(ab_hist)
  dev.off()
}
```

### HSV Time Point Module Scores 

Look at immediate early, early, and late gene expression and add to the data as a module score. Below the baseline plot,
cutoffs are used to better visualize the spread of oHSV transcripts for each stage of gene expression. Ensuring that the expression patterns 
are not exactly the same supports that presence of oHSV transcripts is not due to random spread during 10x sample preparation. 

Immediate early: "HSV1-RL2",
                 "HSV1-RS1",
                 "HSV1-UL54",
                 "HSV1-US1",
                 "HSV1-US12"

Early: "HSV1-UL23",
       "HSV1-UL29",
       "HSV1-UL50",
       "HSV1-UL2"

Late: "HSV1-UL48",
      "HSV1-UL19",
      "HSV1-US6" (note: not present in our data), 
      "HSV1-UL27",
      "HSV1-UL53",
      "HSV1-UL44",
      "HSV1-UL41"


```{r hsv_timepoints, fig.height = 4, fig.width = 16, dependson = c("umap","downsample","matthelp_hsvgenes","matthelp_assaydata","new_hsv_meta")}
# Create lists of time points for HSV gene expression 
imm_early <- list(c("HSV1-RL2",
                    "HSV1-RS1",
                    "HSV1-UL54",
                    "HSV1-US1",
                    "HSV1-US12"))

early <- list(c("HSV1-UL23",
                "HSV1-UL29",
                "HSV1-UL50",
                "HSV1-UL2"))

late <- list(c("HSV1-UL48",
               "HSV1-UL19",
               "HSV1-US6",
               "HSV1-UL27",
               "HSV1-UL53",
               "HSV1-UL44",
               "HSV1-UL41"))

# Add HSV timepoint module scores 
timepoints <- c("Immediate_Early_Genes",
                "Early_Genes",
                "Late_Genes")

hsv_timepoints <- c(imm_early,
                    early,
                    late)
names(hsv_timepoints) <- timepoints

hsv_timepoints <-
  list("Immediate_Early_Genes" = c("HSV1-RL2",
                                   "HSV1-RS1",
                                   "HSV1-UL54",
                                   "HSV1-US1",
                                   "HSV1-US12"),
       "Early_Genes"           = c("HSV1-UL23",
                                   "HSV1-UL29",
                                   "HSV1-UL50",
                                   "HSV1-UL2"),
       "Late_Genes"            = c("HSV1-UL48",
                                   "HSV1-UL19",
                                   "HSV1-US6",
                                   "HSV1-UL27",
                                   "HSV1-UL53",
                                   "HSV1-UL44",
                                   "HSV1-UL41"))
# use this instead below
  # A673_hsv_comb_even <- AddModuleScore(A673_hsv_comb_even,
  #                                 features = hsv_timepoints,
  #                                 ctrl = 5,
  #                                 name = names(hsv_timepoints))

plots <- list()
for (hsv_time in names(hsv_timepoints)) {
  # Add timepoint data as module score
  A673_hsv_comb_even <- AddModuleScore(A673_hsv_comb_even,
                                  features = list(hsv_timepoints[[hsv_time]]),
                                  ctrl = 5,
                                  name = hsv_time)
  
  # Rename AddModuleScore naming syntax
  colnames(A673_hsv_comb_even@meta.data)[which(names(A673_hsv_comb_even@meta.data) == paste0(hsv_time, "1"))] <- hsv_time
  
  # Create FeaturePlots based on the timepoint module scores
  plots[[paste0(hsv_time, "_plot")]] <- 
    FeaturePlot(A673_hsv_comb_even,
                features = hsv_time,
                split.by = "treatment",
                order = TRUE,
                min.cutoff = 0) +
    theme(aspect.ratio = 1)

  print(plots[[paste0(hsv_time, "_plot")]])

# Create FeaturePlots based on the timepoint module scores
  plots[[paste0(hsv_time, "_plot_cutoff15")]] <- 
    FeaturePlot(A673_hsv_comb_even,
                features = hsv_time,
                split.by = "treatment",
                order = TRUE,
                max.cutoff = 15,
                min.cutoff = 0) +
    theme(aspect.ratio = 1)
  
  plots[[paste0(hsv_time, "_plot_cutoff1")]] <- 
    FeaturePlot(A673_hsv_comb_even,
                features = hsv_time,
                split.by = "treatment",
                order = TRUE,
                max.cutoff = 1,
                min.cutoff = 0) +
    theme(aspect.ratio = 1)
  
  plots[[paste0(hsv_time, "rfeatureplot_plot_cutoff1")]] <- 
    r_feature_plot(A673_hsv_comb_even,
                   features = hsv_time,
                   split.by = "treatment",
                   order = TRUE,
                   max.cutoff = 1,
                   min.cutoff = 0) +
    theme(aspect.ratio = 1)
  
  print(plots[[paste0(hsv_time, "rfeatureplot_plot_cutoff1")]])
  
  pdf(paste0("Plots/A673_comb/rfeaturecutoff1_", hsv_time, trtmnt),
      height = 5, width = 10)
  print(plots[[paste0(hsv_time, "rfeatureplot_plot_cutoff1")]])
  dev.off()
}

save(A673_hsv_comb_even,
     file  = "Data/tumor-only-A673_hsv_comb_even-labeled.RData")
```

{r imm_early}

```{r hsv_patchwork_cutoff15, fig.height = 12, fig.width = 16}
hsv_patchwork_hi <- 
  (plots[["Immediate_Early_Genes_plot_cutoff15"]] / 
     plots[["Early_Genes_plot_cutoff15"]] / 
     plots[["Late_Genes_plot_cutoff15"]]) + 
  plot_annotation(title = 'Max Cutoff of 15',
                  theme = theme(plot.title = element_text(size = 18)))

hsv_patchwork_hi

```

```{r hsv_patchwork_cutoff1, fig.height = 12, fig.width = 16}
hsv_patchwork_lo <- 
  (plots[["Immediate_Early_Genes_plot_cutoff1"]] / 
     plots[["Early_Genes_plot_cutoff1"]] / 
     plots[["Late_Genes_plot_cutoff1"]]) +
  plot_annotation(title = 'Max Cutoff of 1',
                  theme = theme(plot.title = element_text(size = 18)))

hsv_patchwork_lo

```

```{r hsv_vln, height = 15, width = 7}
for (hsv_time in names(hsv_timepoints)) {
# Create Violin Plots based on the timepoint module scores
  plots[[paste0(hsv_time, "_vln")]] <- 
    VlnPlot(A673_hsv_comb_even,
            features = hsv_time,
            group.by = "treatment",
            log = TRUE) +
    theme(aspect.ratio = 1)
  
print(plots[[paste0(hsv_time, "_vln")]])
}

hsv_patchwork_vln <- 
  (plots[["Immediate_Early_Genes_vln"]] / 
     plots[["Early_Genes_vln"]] / 
     plots[["Late_Genes_vln"]]) + 
  plot_annotation(title = 'Violin Plot of HSV Timepoint Expression',
                  theme = theme(plot.title = element_text(size = 18)))

hsv_patchwork_vln
```


```{r hsv-vln, dependson="hsv_timepoints"}
Idents(A673_hsv_comb_even) <- A673_hsv_comb_even$treatment

VlnPlot(A673_hsv_comb_even,
        features = "Immediate_Early_Genes",
        split.by = "treatment")

VlnPlot(A673_hsv_comb_even,
        features = "Early_Genes",
        split.by = "treatment")

VlnPlot(A673_hsv_comb_even,
        features = "Late_Genes",
        split.by = "treatment")

```

```{r hsv_hist, dependson="hsv_timepoints", eval = F}
plots <- list()
for (trtmnt in c("2 - oHSV", "4 - oHSV+Trabectedin")) {
  for (hsv_time in names(hsv_timepoints)) {
    # Create histogram Plots based on the timepoint module scores
    Idents(A673_hsv_comb_even) <- A673_hsv_comb_even$treatment
    sobj <- subset(A673_hsv_comb_even,
                   idents = trtmnt)
    plots[[paste0(hsv_time, "_hist")]][[trtmnt]] <-
      feature_hist(sobj,
                   features = hsv_time,
                   cutoff_table = NULL
      ) +
      ggtitle(paste(trtmnt),
              subtitle = hsv_time)
    # Print in Rmd
    print(plots[[paste0(hsv_time, "_hist")]][[trtmnt]])
    # Save as pdf
    pdf(paste0("Plots/A673_comb/hist_", hsv_time, "_", trtmnt, ".pdf"),
        height = 5, width = 5)
    print(plots[[paste0(hsv_time, "_hist")]][[trtmnt]])
    dev.off()
  }
}

```

```{r ridge, dependson="hsv_timepoints", eval = F}
for (hsv_time in names(hsv_timepoints)) {
  Idents(A673_hsv_comb_even) <- A673_hsv_comb_even$oHSV_presence 
  sobj <- subset(A673_hsv_comb_even,
                 idents = "TRUE")
  Idents(sobj) <- sobj$treatment
  sobj <- subset(sobj,
                 idents = c("2 - oHSV", "4 - oHSV+Trabectedin"))
  ridge <- RidgePlot(sobj,
                     features = hsv_time,
                     y.max = 10,
                     same.y.lims = T,
                     log = F,
                     sort = T)
  print(ridge)
  
  pdf(paste0("Plots/A673_comb/ridge", hsv_time, ".pdf"),
      height = 5, width = 10)
  print(ridge)
  dev.off()
}
```

```{r ridge2, eval = F}
for (trtmnt in c("2 - oHSV", "4 - oHSV+Trabectedin")) {
     for (hsv_time in names(hsv_timepoints)) {
  Idents(A673_hsv_comb_even) <- A673_hsv_comb_even$oHSV_presence 
  sobj <- subset(A673_hsv_comb_even,
                 idents = "TRUE")
  Idents(sobj) <- sobj$treatment
  sobj <- subset(sobj,
                 idents = trtmnt)
  sobj <- RenameIdents(sobj,
                       "2 - oHSV" = "2",
                       "4 - oHSV+Trabectedin" = "4")
  ridge <- RidgePlot(sobj,
                     features = hsv_time,
                     y.max = 10,
                     log = T,
                     sort = T) +
    NoLegend()
  print(ridge)
  
  pdf(paste0("Plots/A673_comb/ridge_p2", hsv_time, trtmnt, ".pdf"),
      height = 5, width = 10)
  print(ridge)
  dev.off()
     }
}
```


```{r height = 10, width = 10}
Idents(A673_hsv_comb_even) <- A673_hsv_comb_even$treatment
dot <- subset(A673_hsv_comb_even,
              idents = c("2 - oHSV", "4 - oHSV+Trabectedin")) %>%
  DotPlot(features = c("Immediate_Early_Genes",
                       "Early_Genes",
                       "Late_Genes"),
          scale = F,
          group.by = "treatment",
          cols = c("lightgoldenrod", "darkred"),
          dot.min = 0)
print(dot)

dot2 <- subset(A673_hsv_comb_even,
              idents = c("2 - oHSV", "4 - oHSV+Trabectedin")) %>%
  DotPlot(features = c("Immediate_Early_Genes",
                       "Early_Genes",
                       "Late_Genes"),
          scale = F,
          group.by = "treatment",
          cols = c("lightgoldenrod", "darkred"),
          dot.scale = 20,
          dot.min = -10)
print(dot2)


feature <- subset(A673_hsv_comb_even,
                  idents = c("2 - oHSV", "4 - oHSV+Trabectedin")) %>%
  r_feature_plot(features = c("Immediate_Early_Genes",
                              "Early_Genes",
                              "Late_Genes"),
                 split.by = "treatment",
                 order = TRUE,
                 max.cutoff = 1,
                 min.cutoff = 0) +
  theme(aspect.ratio = 1)

print(feature)
pdf("Plots/A673_comb/featureplot_time.pdf", height = 12.5, width = 8.25)
print(feature)
dev.off()

vln <- subset(A673_hsv_comb_even,
              idents = c("2 - oHSV", "4 - oHSV+Trabectedin")) %>%
  VlnPlot(features = c("Immediate_Early_Genes",
                       "Early_Genes",
                       "Late_Genes"),
          group.by = "treatment",
          same.y.lims = T,
          log = T) +
  NoLegend()
print(vln)

pdf("Plots/A673_comb/vlnplot_time.pdf", height = 12.5, width = 8.25)
print(vln)
dev.off()
```

```{r dot_ab, height = 2, width = 10}
DotPlot(A673_hsv_comb_even,
        features = "oHSV_abundance",
        scale = F,
        group.by = "treatment",
        cols = c("lightgoldenrod", "darkred")
)
```

# Antiviral Analysis

## Gene List

```{r antiviral_genes}
DotPlot(A673_hsv_comb_even,
        features = c(
          "ISG15",
          "IFIT2",
          "ZC3HAV1",
          "MAFA",
          "DDX58",
          "IFIT3",
          "HELZ2",
          "IFITM3"),
        cols = c("lightgoldenrod", "darkred"),
        scale = FALSE)
```

## Differential Gene Expression

Differential gene expression in combination compared to oHSV alone (gene list shown in the table below). GO and KEGG analyses are performed.

```{r deg-trt}
trtdiff <- FindMarkers(A673_hsv_comb_even,
                       ident.1 = "4 - oHSV+Trabectedin",
                       ident.2 = "2 - oHSV",
                       logfc.threshold = 0.15,
                       only.pos = F) %>%
  arrange(-abs(avg_log2FC))

trtdiff <- as.data.frame(trtdiff)
trtdiff <- arrange(trtdiff, desc(avg_log2FC))
degs <- as.vector(trtdiff$avg_log2FC)
names(degs) <- rownames(trtdiff) %>%
  str_replace("HSV1-","")
degs

trt <- list()
trt[["GO-BP"]] <- clusterProfiler::gseGO(
  geneList = degs,
  OrgDb = org.Hs.eg.db::org.Hs.eg.db,
  ont = "BP",
  keyType = "SYMBOL",
  nPermSimple = 10000,
  eps = 0)

trt[["GO-BP"]] <- mutate(trt[["GO-BP"]],
      p.adjust = -log10(p.adjust))

plots <- list()
if (nrow(trt[["GO-BP"]]) > 0) {
  plots[["GO-BP"]] <- enrichplot::dotplot(trt[["GO-BP"]],
                                          x = "NES",
                                          showCategory = 30,
                                          font.size = 8) +
    labs(title = "Upregulated Gene Sets in Combination Therapy",
         subtitle = "GO-BP Gene Sets")
} else {
  plots[["GO-BP"]] <-
    ggplot(tibble(x = "A", y = "A",
                  text = "No significant hits"),
           aes(x = x, y = y, label = text)) +
    geom_text() +
    theme(axis.text = element_text(size = 5)) +
    labs(title = "Upregulated Gene Sets in Combination Therapy",
         subtitle = "GO-BP Gene Sets")
}

plots[["GO-BP"]]

# enrichplot::dotplot(trt[[1]][["GO-BP"]],
#                     x = "NES",
#                     showCategory = 15,
#                     font.size = 9) +
#   labs(title = paste(t, c),
#        subtitle = "GO-BP Gene Sets")
# 
# enrichplot::dotplot(trt[[2]][["GO-BP"]],
#                     x = "NES",
#                     showCategory = 15,
#                     font.size = 9) +
#   labs(title = paste(t, c),
#        subtitle = "GO-BP Gene Sets")

```

```{r kegg, dependson='deg-trt'}
hs <- org.Hs.eg.db
rownames(trtdiff) <- rownames(trtdiff) %>%
  str_replace("HSV1-","")
trtdiff <- select(hs,
                  keys = rownames(trtdiff),
                  columns = c("ENTREZID", "SYMBOL"),
                  keytype = "SYMBOL") %>%
  na.omit()

## Test from Yogesh
conversion <- list()
for(i in names(degs)) {
  conversion[[i]] <- clusterProfiler::bitr(
    geneID = sample_marks[[i]]$SYMBOL,
    fromType = "SYMBOL",
    toType = "ENTREZID",
    OrgDb = "org.Hs.eg.db"
  )
  degs[[i]] <- as.data.frame(degs[[i]]) %>%
    inner_join(conversion[[i]], by = "SYMBOL") %>%
    pull(degs[[i]], name = ENTREZID)
}

subsetted_list <- list()
gsea_KEGG <- list()
for (ids in unique(entrezgene_id$cluster)) {
  temp_df <- dplyr::filter(entrezgene_id, cluster == ids)
  subsetted_list[[ids]] <- temp_df$avg_log2FC
  names(subsetted_list[[ids]]) <- temp_df$ENTREZID
  gsea_KEGG[[ids]] <- clusterProfiler::gseKEGG(subsetted_list[[ids]],
                                               organism = "hsa",
                                               keyType = "ncbi-geneid")
}

##
# trt[["KEGG"]] <- clusterProfiler::enrichKEGG(
#   gene = degs,
#   organism = "hsa",
#   keyType = "ncbi-geneid")
# 
# trt[["KEGG"]] <- clusterProfiler::gseKEGG(geneList = degs,
#                                           organism = 'hsa')

gsea_KEGG[[ids]] <- mutate(gsea_KEGG[[ids]],
                           p.adjust = -log10(p.adjust))

#plots <- list()
if (nrow(gsea_KEGG[[ids]]) > 0) {
  plots[["KEGG"]] <- enrichplot::dotplot(trt[["KEGG"]],
                                         x = "NES",
                                         showCategory = 15,
                                         font.size = 8) +
    labs(title = "Upregulated Pathways in Combination Therapy",
         subtitle = "KEGG Gene Sets")
} else {
  plots[["KEGG"]] <-
    ggplot(tibble(x = "A", y = "A",
                  text = "No significant hits"),
           aes(x = x, y = y, label = text)) +
    geom_text() +
    theme(axis.text = element_text(size = 5)) +
    labs(title = "Upregulated Pathways in Combination Therapy",
         subtitle = "KEGG Gene Sets")
}

plots[["KEGG"]]
```


```{r trtdiff, dependson="deg-trt"}
# Create interactive datatable showing DEG list
#trtdiff <- as.data.table(trtdiff)
DT::datatable(trtdiff, 
              rownames = TRUE,
              extensions = c('FixedColumns',
                             'Buttons'),
              options = list(
                pageLength = 10,
                scrollX = TRUE,
                scrollCollapse = TRUE,
                dom = 'Bfrtip',
                buttons = c('copy',
                            'csv',
                            'excel')
              ))
```


```{r gobp, dependson="deg-trt"}
# Create interactive datatable showing DEG list
gobp <- as.data.table(trt[["GO-BP"]])
DT::datatable(gobp,
              rownames = TRUE,
              extensions = c('FixedColumns',
                             'Buttons'),
              options = list(
                pageLength = 10,
                scrollX = TRUE,
                scrollCollapse = TRUE,
                dom = 'Bfrtip',
                buttons = c('copy',
                            'csv',
                            'excel')
              ))
```


```{r}
sessionInfo()
```
